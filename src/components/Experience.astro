---
import { jobs as experiences } from '../data/jobs';
import { education } from '../data/education';

// Build sidebar items with sub-entries
const sidebarSections = [
  {
    id: 'experience',
    label: 'Expérience',
    children: experiences.map((exp, i) => ({ id: `exp-${i}`, label: exp.company.split('(')[0].trim() }))
  },
  {
    id: 'formation',
    label: 'Formation',
    children: education.map((edu, i) => ({ id: `edu-${i}`, label: edu.company.split('(')[0].trim() }))
  },
  {
    id: 'stack',
    label: 'Tech Stack',
    children: []
  },
];

const cardItems = [
  { id: 'experience', title: 'Expérience Professionnelle', items: experiences, prefix: 'exp' },
  { id: 'formation', title: 'Formation', items: education, prefix: 'edu' },
];
---

<div class="bg-gray-900 text-white pt-24 pb-16">
  <div class="max-w-7xl mx-auto px-4 flex gap-0 md:gap-8">

    <!-- Sticky Sidebar (Desktop only) -->
    <aside class="hidden lg:block w-56 shrink-0">
      <nav class="sticky top-28 space-y-1" id="sidebar-nav">
        {sidebarSections.map(s => (
          <div>
            <a href={`#${s.id}`} data-section={s.id}
               class="sidebar-link block px-4 py-2.5 text-sm font-medium text-gray-500 rounded-lg border-l-2 border-transparent hover:text-white hover:bg-gray-800/50 transition-all">
              {s.label}
            </a>
            {s.children.length > 0 && (
              <div class="ml-4 mt-0.5 space-y-0.5">
                {s.children.map(child => (
                  <a href={`#${child.id}`} data-section={child.id}
                     class="sidebar-link block px-3 py-1.5 text-[11px] text-gray-600 rounded-md border-l-2 border-transparent hover:text-gray-300 hover:bg-gray-800/30 transition-all truncate">
                    {child.label}
                  </a>
                ))}
              </div>
            )}
          </div>
        ))}
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 min-w-0">

      {cardItems.map(section => (
        <section id={section.id} class="mb-20">
          <h2 class="text-3xl font-bold mb-10 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
            {section.title}
          </h2>

          <div class="space-y-6">
            {section.items.map((item, i) => (
              <div id={`${section.prefix}-${i}`} class="bg-gray-800/50 p-5 rounded-xl border border-gray-700/50 hover:border-blue-500/30 transition-all group">
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-3">
                  <div>
                    <h3 class="text-lg font-bold group-hover:text-blue-300 transition-colors">{item.role}</h3>
                    <p class="text-gray-400 text-sm font-medium">{item.company}</p>
                  </div>
                  <span class="text-blue-400 text-xs font-mono bg-gray-900/80 px-3 py-1 rounded-full border border-gray-700 whitespace-nowrap self-start">
                    {item.date}
                  </span>
                </div>

                <p class="text-gray-300 text-sm italic mb-4">{item.description}</p>
                
                <div class="grid gap-2">
                  {item.details.map((detail) => (
                    <div class="bg-gray-700/30 p-3 rounded-lg border-l-2 border-blue-500">
                      <h4 class="font-bold text-white text-xs mb-1">{detail.title}</h4>
                      <p class="text-[12px] text-gray-300 leading-relaxed">{detail.content}</p>
                    </div>
                  ))}
                </div>

                <div class="flex flex-wrap gap-1.5 mt-4">
                  {item.tags.map((tag) => (
                    <span class="px-2 py-0.5 bg-gray-900 text-gray-400 text-[10px] rounded-md border border-gray-700">
                      #{tag}
                    </span>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </section>
      ))}

      <!-- Tech Stack -->
      <section id="stack">
        <h2 class="text-3xl font-bold mb-10 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
          Tech Stack
        </h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
          {[
            { name: "IBM z/OS", cat: "mainframe" },
            { name: "JCL", cat: "mainframe" },
            { name: "COBOL", cat: "mainframe" },
            { name: "DB2", cat: "mainframe" },
            { name: "CICS", cat: "mainframe" },
            { name: "Zowe", cat: "mainframe" },
            { name: "Python", cat: "dev" },
            { name: "React", cat: "dev" },
            { name: "Node.js", cat: "dev" },
            { name: "Docker", cat: "devops" },
            { name: "Ansible", cat: "devops" },
            { name: "Git", cat: "devops" },
            { name: "Linux", cat: "devops" },
            { name: "Jenkins", cat: "devops" },
            { name: "VSCode", cat: "tools" },
            { name: "REST API", cat: "dev" },
          ].map(tech => (
            <div class={`px-4 py-3 rounded-lg border text-sm font-medium text-center transition-all hover:scale-105 ${
              tech.cat === 'mainframe' ? 'bg-blue-950/40 border-blue-800/50 text-blue-300' :
              tech.cat === 'dev' ? 'bg-purple-950/40 border-purple-800/50 text-purple-300' :
              tech.cat === 'devops' ? 'bg-green-950/40 border-green-800/50 text-green-300' :
              'bg-gray-800/50 border-gray-700/50 text-gray-300'
            }`}>
              {tech.name}
            </div>
          ))}
        </div>
        <div class="flex gap-6 mt-4 text-xs text-gray-500 justify-center">
          <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Mainframe</span>
          <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-purple-500"></span> Dev</span>
          <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-green-500"></span> DevOps</span>
        </div>
      </section>

    </main>
  </div>
</div>

<script>
  const links = document.querySelectorAll('.sidebar-link');
  const targets = document.querySelectorAll('[id]');
  
  function updateActive() {
    let current = '';
    targets.forEach(el => {
      const top = el.getBoundingClientRect().top;
      if (top <= 150) current = el.id;
    });
    
    links.forEach(link => {
      const isActive = link.getAttribute('data-section') === current;
      link.classList.toggle('text-white', isActive);
      link.classList.toggle('text-gray-500', !isActive && link.classList.contains('text-sm'));
      link.classList.toggle('text-gray-600', !isActive && !link.classList.contains('text-sm'));
      link.classList.toggle('text-gray-300', isActive && !link.classList.contains('text-sm'));
      link.classList.toggle('border-blue-500', isActive);
      link.classList.toggle('border-transparent', !isActive);
      link.classList.toggle('bg-gray-800/50', isActive && link.classList.contains('text-sm'));
    });
  }
  
  window.addEventListener('scroll', updateActive);
  updateActive();
</script>
